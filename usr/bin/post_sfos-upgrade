#!/bin/sh
set -ufC

export LANG="C"  # Engineering English only
export LC_CTYPE="POSIX"
export LC_COLLATE="POSIX"

called="$(basename "$0")"
if ! echo " $(id -un) $(id -Gn) " | fgrep -q ' root '
then
  echo "Aborting: $called must be started with root privileges."
  exit 1
fi

if ! [ "$(uptime | cut -f 1 -d ',' | rev | grep '^nim ' | cut -f 2 -d ' ' | rev)" -lt "4" ] 2> /dev/null
then
  echo "Notice: Mind that $called is best run on a freshly rebooted device."
  echo
fi

echo "- Cleaning logfiles of duplicate entries."
tidy_log-dupes "$@"
ret_tidy=$?
case $ret_tidy in
[1-9]|[1-9][0-9]|1[0-1][0-9])
  echo "Warning: Failure while tiding $ret_tidy extant log file(s)!"
  ;;
120)
  echo "Warning: Failure while tiding 120 or more extant log files!"
  ;;
121)
  echo "Notice: Found no log file to tidy."
  ;;
*)
  # For 0 (all fine), 123 (cannot access logdir), 124 (error parsing parameters) and 126 (called help):
  # Do nothing.
  ;;
esac
echo

if which store-client > /dev/null 2>&1
then
  echo "- Removing outdated Store version info."
  for i in '-TERM' '-QUIT' '-HUP' '' '-KILL' '-Failed_to_kill_store-client'
  do
    if pgrep store-client > /dev/null
    then pkill $(echo $i) store-client
    else break  
    fi
  sleep 1
  done
  echo
fi
rm -f /home/nemo/.cache/sailfish-osupdateservice/os-info /home/nemo/.cache/store-client/os-info

if which zypper > /dev/null 2>&1
then
#  No need to be "brutal":
#  echo "- Cleaning zypper's caches:"
#  zypper clean -m || exit $?
  echo "- Refreshing zypper's caches:"
  zypper refresh || exit $?
  echo
fi

echo "- Refreshing pkcon's caches:"
pkcon refresh || exit $?

# Syncing, as I could not determine if pkcon and zypper already do that:
sync

