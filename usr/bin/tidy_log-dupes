#!/bin/sh
set -uC

export LANG="C"  # Engineering English only
export LC_CTYPE="POSIX"
export LC_COLLATE="POSIX"

called="$(basename "$0")"
if [ -z "$*" ]
then logdir="/var/log"
else
  logdir="$1"
  shift
  if [ ! -d "$logdir" ] || [ -n "$*" ]
  then
    if [ -n "$*" ]
    then echo "No extra parameters expected, but set: $*" >&2
    fi
    echo "Usage: $called [<logdirectory>]"
    echo "Without a parameter it will use /var/log as log directory."
    exit 1
  fi
fi

cd "$logdir" || exit $?

# Removing stale metadata downloads left over by version --dup
# rm -rf UpdateTestcase-*

if ! set -o pipefail
then echo "Notice: This shell does not support \"-o pipefail\"." >&2
fi

retc=0
targets="systemupdate_*.log-dupes.txt"
for logfile in $targets
do
  if [ "$logfile" != "$targets" ]
  then
    tidied_log="$(echo "$logfile" | rev | cut -f 2- -d '-' | rev).txt"
    if cat "$logfile" | sed 's/\cM//g' | sed 's/Installing: [0-9][0-9]*%\x1b\[K//g' | sed 's/\x1b\[K/\n/g' | sed 's/^\[[0-9][0-9]* %] //g' | sed 's/: \[[0-9][0-9]* %]$//g' | sed 's/: [0-9][0-9]*%$//g' | uniq > "$tidied_log"
    then rm -f "$logfile"
    else retc=1
    fi
  fi
done

exit $retc

